\documentclass[12pt,a4paper]{article}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{geometry}
\usepackage{enumitem}
\setitemize{noitemsep}
\usepackage{tabularx}
\usepackage{setspace}
\newcolumntype{x}{>{\centering\arraybackslash}X}

\newtheorem{lemma}{Lemma}

\usepackage{fontspec,xunicode}
\defaultfontfeatures{Mapping=tex-text}
\setsansfont{TeX Gyre Heros}
\setromanfont{Heuristica}

\usepackage{unicode-math}
\setmathfont{TeX Gyre Schola Math}

\usepackage{titlesec} %Package for adjusting the fonts of the \section and \subsection and so forth.
\titleformat{\section}{\Large\bfseries\sffamily}{\thesection.}{1em}{}
\titleformat{\subsection}{\large\bfseries\sffamily}{\thesubsection.}{1em}{}
\titleformat{\subsubsection}{\normalsize\bfseries\sffamily}{\thesubsubsection.}{1em}{}

\onehalfspacing

\begin{document}
\global\long\def\bpi{\bar{p}}%
\global\long\def\upi{\underline{p}}%


%\section{Introduction}

%* Some p
\section{Model}

We consider a mixed population of two types, selfish and group reciprocators (GR). At the beginning of each generation, the population randomly divides into a large number of groups of size~$G$ each.
Let~$p$ denote the population share of GR types. 
Let~$p_g$ be the proportion of GR in group~$g$, which is distributed binomially.

At every step~$t$, everybody interacts with everybody. In each pair, each individual chooses between cooperation and defection. Cooperation entails a cost~$c$ to the cooperator and a benefit~$b$ to her partner. Defection carries no costs. That is, each pair plays the following Prisoner's Dilemma game:
\begin{center}
    \begin{tabularx}{0.5\textwidth}{|x|x|x|}
        \hline
        &   Cooperate   &   Defect  \\
        \hline
        Cooperate   &   $b-c$   &   $-c$    \\
        \hline
        Defect  &   $b$ &   $0$   \\
        \hline
    \end{tabularx}
\end{center}

Selfish types always defect, A GR individual~$i$ starts by cooperating, and then cooperates with all individuals belonging to group~$g$ with a probability~$\phi(l_{gi})$, where~$l_{gi}$ is the proportion of individuals from group~$g$ who cooperated with individual~$i$ in round $t-1$.
$\phi(\cdot)$ is monotonically weakly increasing. We consider the cutoff strategy: 
$$
    \phi(l_{gi}) =
    \begin{cases}
        1   &   \text{if } l_{gi} \geq k  \\
        0   &   \text{otherwise.}
    \end{cases}
$$
The fitness is the payoff at the limit where~$t\to\infty$. Equivalently, since the game always settles to a stationary action profile, it is the average payoff of~$T$ rounds when~$T\to\infty$.

Given this behaviour, GR in all groups where $p_g \geq k$ help all individuals in other groups where $p_g \geq k$ and defect against members of all other groups. GR in other groups always defect.
%
Individuals' fitness therefore depends only on whether they are in a ``supraliminal" group with $p_g \geq k$, and on their type. Let~$q$ be the 
proportion of supraliminal groups. Let~$\bpi$ be the proportion of 
GR individuals in supraliminal groups (out of the total population in such groups). Let~$\upi$ be the proportion of GR individuals in subliminal groups (out of the total population in such groups). It follows that
\begin{itemize}
    \item Group reciprocators in supraliminal groups get a payoff of~$\bpi qb - qc$.
    \item Selfish types in supraliminal groups get~$\bpi qb$.
    \item Group reciprocators and selfish types in subliminal groups get~$0$.
\end{itemize}

After each generation, reproductive success is proportional to fitness, the total population size stays the same, and children are remixed randomly into new groups of the same size.
%
The mean fitness of the GR type is

\begin{equation*}
\frac{
  \bpi q(q(\bpi b - c))
}{
  p
}
\end{equation*}

and the mean fitness of selfish types is

\begin{equation*}
\frac{
  (1 - \bpi)q(q\bpi b)
}{
  1 - p
}
\end{equation*}

After rearranging, the mean fitness of reciprocators is higher if


\begin{equation}
\label{gr-wins}
\frac{ \bpi - p}{ 1 - p} \ge \frac{c}{b}.
\end{equation}

where 

\[
\bpi = E[p_g | p_g \ge k] = \frac{1}{G} \frac{\sum_{l=kG}^G l \mathrm{Binom}(l,G,p)}{\sum_{l=kG}^G \mathrm{Binom}(l,G,p)}
\]

The LHS of \eqref{gr-wins} is decreasing in $p$ and is equal
to the threshold $k$ when $p = 0$.\footnote{
    When the share of GR in the population is very small, the probability that $p_g = k$ conditional on~$p_g\geq k$ goes to one.
}

\begin{proof}
We will first prove an auxiliary lemma and then the main result.
\begin{lemma}
\label{lemma:eqiv_formulation}
Let $x_1,x_2,...,x_n$ be iid Binomially-distributed variables with probability of success $p$, and let $x_i=1$ denote the event where $x_i$ fails. Then showing that $\frac{ \bpi - p}{ 1 - p}$ decreases in $p$ is equivalent to showing that $\frac{p(x_1=1|S_n \leq k)}{p(x_1=1)}$ increases in $p$, where $S_n=x_1+x_2+...+x_n$.
\end{lemma}
\textbf{Proof of Lemma \ref{lemma:eqiv_formulation}}

First note that proving that the LHS of \eqref{gr-wins} is decreasing in $p$ is equivalent to proving that $1-\frac{ \bpi - p}{ 1 - p} = \frac{ 1- \bpi}{ 1 - p}$ is increasing in $p$. Second, note that 
% if $p$ is the probability of success of a Binomially-distributed variable $x_i$, then 
$1- \bpi$ captures the expected proportion of failures of a Binomially-distributed variable given that the proportion of successes was at least $k$, or, put differently, given that the proportion of failures was at most $k$. Finally, we can replace the expected proportion of failures with the probability of a failure. All in all, we get that proving that $\frac{ 1- \bpi}{ 1 - p}$ is increasing in $p$ is equivalent to showing that $\frac{p(x_1=1|S_n \leq k)}{p(x_1=1)}$ is increasing in $p$.
% hence decreasing in $q$.
\vspace{0.3cm}

\textbf{Proving the main result}
\vspace{0.3cm}

Lemma \ref{lemma:eqiv_formulation} implies that if $x_i=1$ denotes the event where $x_i$ fails, and $S_n$ counts the number of failures among $n$ trials, then we need to show that $\frac{p(x_1=1|S_n \leq k)}{p(x_1=1)}$ increases in the probability of success $p$.
For tractability, we will now revert to the more standard notation of $x_i=1$ as denoting the event where $x_i$ \textit{succeeds} (s.t. $S_n$ counts the number of successes among $n$ trials), and show that $\frac{p(x_1=1|S_n \leq k)}{p(x_1=1)}$ \textit{decreases} rather than increases in the probability of success $p$.
\vspace{0.6 cm}

\textbf{Proof}

\vspace{0.3 cm}
$\frac{p(x_1=1|S_n \leq k)}{p(x_1=1)}=\frac{p(s_n \leq k|x_1=1)}{p(s_n \leq k)}=\frac{p(s_{n-1} \leq k-1)}{qp(s_{n-1} \leq k)+pp(s_{n-1} \leq k-1)}$

\vspace{0.3cm}
$=\frac{p(s_{n-1} \leq k-1)}{q(p(s_{n-1} \leq k)-p(s_{n-1} \leq k-1))+p(s_{n-1} \leq k-1)}=\frac{p(s_{n-1} \leq k-1)}{qp(s_{n-1}=k)+p(s_{n-1} \leq k-1)}.$
\vspace{0.3cm}

Using a known result,\footnote{See equations (3) and (4) in https://mathworld.wolfram.com/BinomialDistribution.html.} according to which
\begin{equation*}
    p(s_n \leq k) = \frac{n!}{(n-k-1)!k!}\int_0^q t^{n-k-1}(1-t)^k dt = \frac{n!}{(n-k-1)!k!}\int_0^1 q^{n-k} s^{n-k-1} (1-qs)^k ds,
\end{equation*}
we get that $\frac{p(x_1=1|S_n \leq k)}{p(x_1=1)}$ is decreasing in $p$ if and only if $\frac{q \binom{n-1}{k} p^k q^{n-k-1}}{\frac{(n-1)!}{(n-k-1)!(k-1)!}\int_0^1 q^{n-k}s^{n-k-1}(1-qs)^{k-1} ds}$ is decreasing in $q$, i.e., if and only if $\frac{\binom{n-1}{k} p^k}{\frac{(n-1)!}{(n-k-1)!(k-1)!}\int_0^1 s^{n-k-1}(1-qs)^{k-1} ds}$ is decreasing in $q$.
\vspace{0.3cm}
Thus, it is sufficient to show that $\int_0^1 s^{n-k-1}(\frac{1-qs}{1-q})^{k-1}\frac{1}{1-q} ds$ is increasing in $q$. Since $(\frac{1-qs}{1-q})^{k-1}\frac{1}{1-q}$ is non-decreasing in $q$ for every $s \in [0,1]$, the proof is complete.

\end{proof}
%
It follows that there is a unique ESS with a positive share of group
reciprocators if and only if $k > \frac{c}{b}$. Otherwise the population is homogeneously selfish in the unique ESS.

\end{document}
%%% THE REST OF THE ATTEMPTS TO PROVE ARE IN THE SEPARATE FILE

\subsection*{Proof that \eqref{gr-wins} goes to $k$ as $p \to 0$}


Consider

\[
\frac{\bpi - p}{1-p}
\]
The limit as $p \to 0$ is given by $\bpi$. For $k=0$ this is
0 since $\bpi = p$. For $k>0$, write
\[
\bpi=\frac{1}{G}\frac{\sum_{l=kG}^{G}l\phi(l,G,p)}{\sum_{l=kG}^{G}\phi(l,G,p)}=\frac{1}{G}\frac{\sum_{l=kG}^{G}l\binom{G}{l}p^{l}(1-p)^{G-l}}{\sum_{l=kG}^{G}\binom{G}{l}p^{l}(1-p)^{G-l}}.
\]

The limit of this is given by L'H\^{o}pital's rule, since the denominator
goes to zero. Differentiating top and bottom gives
\[
\frac{1}{G}\frac{\sum_{l=kG}^{G}l\binom{G}{l}(l-Gp)p^{l-1}(1-p)^{G-l-1}}{\sum_{l=kG}^{G}\binom{G}{l}(l-Gp)p^{l-1}(1-p)^{G-l-1}}
\]
so we have to apply the rule again. Continuing thus we eventually hit:
\[
\frac{1}{G}\frac{kG\binom{G}{l}(l-Gp)(l-1-Gp)(\cdots)(l-kG-Gp)p^{0}(1-p)^{G-2kG}+\cdots}{\binom{G}{l}(l-Gp)(l-1-Gp)(\cdots)(l-kG-Gp)p^{0}(1-p)^{G-2kG}+\cdots}
\]
 where all but the first terms vanish, leaving
\[
\frac{1}{G}\frac{kG\binom{G}{l}(l-Gp)(l-1-Gp)(\cdots)(l-kG-Gp)p^{0}(1-p)^{G-2kG}}{\binom{G}{l}(l-Gp)(l-1-Gp)(\cdots)(l-kG-Gp)p^{0}(1-p)^{G-2kG}}=\frac{1}{G}kG=k.
\]


(Old stuff)

\begin{align}
    q & = & 1 - CDF(G, p') \\
    \bpi & = & E[p_k | p_k \ge c] \\
    \upi & = & E[p_k | p_k < c]
\end{align}

Where $CDF$ is the binomial distribution of $p'$ out of $G$ successes, and
the conditional expectations are also taken according to this distribution.

Computations are in continuous-model-computations.R in dropbox. Plotting
reveals:

When $p$ is sufficiently below $c$, $p' = p$ and group reciprocity is 
selectively neutral, since group reciprocators and selfish types are
almost all in subliminal groups.

For some parameters, and intermediate values of $p$, $p'>p$ so that
group reciprocity is being selected for. That is, some groups successfully
manage to cooperate with other groups and have higher average fitness.

For high enough values of $p$, $p' < p$. This is because when almost everyone
is cooperating, a selfish type is almost surely in a supraliminal group
and benefits by freeriding.

Conjectures and questions.

1. What if the threshold can evolve? Might higher thresholds always 
be beneficial? If so, probably only few group reciprocators exist,
and very few are in supraliminal groups. One way to do this is
generalize the model to have high- and low-threshold types, and see
who wins. Note that in the model as is, a selfish type just has a
"threshold" of above 1. Another approach is to ask if a single
person with a different threshold can invade. He will change the
behaviour of other groups to him, but as there are many groups,
we can ignore the effects on other people's fitness and just
ask if he outcompetes other group reciprocators.
\end{document}